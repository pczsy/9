<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修破解点评网字体反爬，深入挖掘系统背后的原理' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>破解点评网字体反爬，深入挖掘系统背后的原理</center></div><div class='banquan'>原文出处:本文由博客园博主上海小胖提供。<br/>
原文连接:https://www.cnblogs.com/moonhmily/p/11361601.html</div><br>
    <p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理0.png" /></p>
<p>上次数独（<a href="https://www.cnblogs.com/moonhmily/p/11312887.html">旁友数独会伐啦？python秒解数独了解下伐啦？</a>）后，老王好像从哪里得到了风声，跟我说少往他们家带扑克牌……意思里你的家庭矛盾都是因为一副扑克牌咯？</p>
<p>行，那我这段时间先歇一歇，来日方长……</p>
<p>那闲着也是闲着，不能去隔壁了，也不能让小胖这双手停下来不是……</p>
<p>那就上点评网找找妹子乐趣，然后就发现点评的反爬做的是真厉害。各个方面的反爬都有涉及，今天我们主要来看一下字体反爬这个玩意儿。</p>
<h1 id="演示环境">演示环境</h1>
<ul>
<li>操作系统：windows10</li>
<li>python版本：python 3.7</li>
<li>代码编辑器：pycharm 2018.2</li>
<li>使用模块：requests,json,re,fontTools</li>
</ul>
<h1 id="什么是字体反爬">什么是字体反爬？</h1>
<p>首选我们先来看一下点评网的评论信息。</p>
<p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理1.png" /></p>
<p>从这里可以看到，网页上显示的文字和源码中显示的文字有些出入，并不是一一对应，那继续查看sources中的代码。</p>
<p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理2.png" /></p>
<p>可以看到，评论中的某些文字点评网做了特殊处理，这就是所谓的字体反爬。</p>
<h1 id="抓取数据">抓取数据</h1>
<p>前面的步骤，我们已经知道点评网对评论内容做了处理，至于是如何处理，这里我们先不管，还是先把数据拿到再说。要是数据都没有拿到，还怎么对数据进行处理呢？</p>
<p>首先使用谷歌的network，对所有请求进行抓包。然后随便搜索一个评论中的某些东西，找到返回的评论数据请求。这里我使用评论人的名字进行搜索，找到其中的请求。有没有觉得这个请求就是返回的评论数据呢。那来验证下。因为这里返回的是一个json数据，可以借助在线json数据查看工具，方便我们对内容进行查看。</p>
<p>将数据复制下来，然后在浏览器中输入网址<code>json.cn</code></p>
<p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理3.png" /></p>
<p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理4.png" /></p>
<p>接着就能看到解析出来的json数据。</p>
<p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理5.png" /></p>
<p>经过分析，我们知道所有的评论数据都在<code>['reviewAllDOList']</code>，这个集合里装了当前页面前10人的评论数据。这样就可以通过列表遍历的方式拿到相应的数据。<br />
点击这个url的headers，找到请求的url，准备获取数据。</p>
<p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理6.png" /></p>
<p><strong>注意：</strong></p>
<ul>
<li>这个获取到的url只能使用一会儿，过一会就会变化。如果一直使用这个url请求，后面就会得不到数据。所以后续当请求不到数据的时候，就需要刷新网页，获取一个新的url。因为url中有个_token参数是每次变化的。</li>
<li>然后下面框中的内容也必须在请求头中添加上去，否则也还是得不到数据。</li>
<li>这里的重点是在字体反爬，所以其他的一些反爬在这里就不进行赘述了。</li>
</ul>
<p>至此就找到请求的评论接口数据，直接请求这个url，就能得到我们想要的数据。</p>
<pre><code><code>import requests
import json
import re


def get_page_info():
    # 首先分析网页，找到返回评论数据的url，这个url就会直接返回评论数据了，但是urlt中的token是会变化的，只能用一会儿，我也不知道一会儿是好久,得不到数据了就换url吧
    url = &#39;http://www.dianping.com/ajax/json/shopDynamic/allReview?shopId=131013635&amp;cityId=1604&amp;shopType=10&amp;tcv=7bbq1hdmsj&amp;_token=eJxVTstugkAU%2FZe7nsBcBlBIulBrGxC0MmATTReACoSCFIg4Nv33Thu66Oq8k%2FMJrXMEGymlOhK4nlqwARWqmECg72RimAZOkFkTauoE0v%2BehRqBpN09gn1glkEmhv72YwRSH9BgJpma0hmpJqmmE%2B2348gK5H3f2Ko6DINyLOK6KepMSS%2BV2uWXRkWGFJnJDHkF5KQK5URiOWI8Yv%2BnfflddrsiqyU7ubeQd3r3cQ78Loyof58HQlgrzjXhpejxiHn3Zb%2BO%2BHUjFtOZCMrkOc%2Fi6lYlWbZbrLKeJ1u6RqfxUuaHhWitZb0Oy4RHrnveV0X6%2FhQ0VbPZvu5FOZ%2B91Oi4wwN8fQMlVWIi&amp;uuid=c59d33fd-e043-a0f5-f6e1-79ae90d14254.1565007755&amp;platform=1&amp;partner=150&amp;optimusCode=10&amp;originUrl=http%3A%2F%2Fwww.dianping.com%2Fshop%2F131013635&#39;


    # 定义模拟请求头
    headers = {
        &#39;User-Agent&#39;:&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36&#39;,
        &#39;Cookie&#39;: &#39;cy=8; cye=chengdu; _lxsdk_cuid=16c61bb35536e-0e2ab00cb9c2a8-c343162-144000-16c61bb35547b; _lxsdk=16c61bb35536e-0e2ab00cb9c2a8-c343162-144000-16c61bb35547b; _hc.v=c59d33fd-e043-a0f5-f6e1-79ae90d14254.1565007755; s_ViewType=10; __utmz=1.1565010551.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); _lx_utm=utm_source%3DBaidu%26utm_medium%3Dorganic; __utma=1.1978331348.1565010551.1565010551.1565161172.2; __utmc=1; _lxsdk_s=16c6b1cf413-8ae-d6-7b8%7C%7C31&#39;,
        &#39;Referer&#39;:&#39;http://www.dianping.com/shop/131013635&#39;,
        &#39;Connection&#39;: &#39;keep-alive&#39;,
    }


    # 使用requests库请求url，得到数据json数据
    result_json_str = requests.get(url,headers=headers).text
    # 应为返回的数据是里面包含富文本数据，所以首先使用正则表达式删除标签
    result_json_str = re.sub(&#39;&lt;.*?&gt;&#39;,&#39;&#39;,result_json_str)

    # json数据其实就是一个字符串，所以我们需要先将json转化为python能操作的字典
    result = json.loads(result_json_str)
    # 分析得到的数据，得到我们需要的所有评论在result[&#39;reviewAllDOList&#39;]里面
    all_review = result[&#39;reviewAllDOList&#39;]


    # 遍历得到的所有评论
    for review in all_review:
        # 得到用户名
        username = review[&#39;user&#39;][&#39;userNickName&#39;]
        # 得到评论内容
        content = review[&#39;reviewDataVO&#39;][&#39;reviewBody&#39;]
        # 这里我们就是简单的显示出内容就是了，没有进行储存
        print(&#39;*&#39;*30,&#39;\n&#39;,username,content,&#39;\n&#39;,&#39;*&#39;*30)</code></pre>
<p>运行代码，查看数据，得到的数据果然就是经过处理的。</p>
<p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理7.png" /></p>
<h1 id="破解字体反爬">破解字体反爬</h1>
<p>上面虽然拿到了数据，但是这些都是经过处理之后的数据，拿着完全不能用，所以还是得想办法将他给破解下。</p>
<p>首先我们分析网页得知，这些处理之后的数据class都为review，然后他的字体都是<code>'PingFangSC-Regular-review'</code></p>
<p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理8.png" /></p>
<p>猜想这就是点评网自己定义的字体。居然自定义了字体，那么网页中肯定需要加载字体文件，所以果断打开network对字体文件进行抓包。</p>
<p>搜索关键字<code>'PingFangSC-Regular-review'</code>，就能找到相应的信息。</p>
<p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理9.png" /></p>
<p>我们可以看到，点评网有许多个自定义的字体，这里只需要找自己想要的字体文件即可，即找字体文件的url。只是这些字体文件一般都是.woff或者.ttf结尾的，我们可以将下面的滚动条往右边拖动，就能找到一个.woff的url了。</p>
<p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理10.png" /></p>
<p>发现这个url前面是以<code>//</code>开始的，那尝试直接在网址前面加https就行了，那么完整的url就是<br />
<code>https://s3plus.meituan.net/v1/mss_73a511b8f91f43d0bdae92584ea6330b/font/c667da25.woff</code></p>
<p>然后在浏览器中输入这个网址，就可以下载一个后缀是.woff的字体文件。</p>
<p>为了方便查看字体文件的内容，我们还需要下载fontCreator这个软件。使用这个软件打开我们刚才下载的文件，就能够看到相应的值。fontCreator官网地址为<br />
<code>https://www.high-logic.com/font-editor/fontcreator</code></p>
<p>使用fontCreator打开这个woff文件，如下图所示。</p>
<p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理11.png" /></p>
<p>我们得把这里面所有的文字按顺序都写出来，并用一个列表保存，空的数据使用''表示。<br />
是的，你没有看错，将这些文字全部写下。</p>
<p>这些就是字体的形状，我们已经认识了这些字，但我们还得让程序也认识这些字，当然你也可以使用机器学习来识别这些文字，注意：一定要按顺序来，不能遗漏，不然的话对应关系会出错，替换出来的结果也就会出错。</p>
<p>我们把文字敲出来之后，然后需要得到字体形状对应的名字，对应代码字符串。这里需要使用<code>fontTools</code>这个第三方库来处理字体文件。</p>
<pre><code><code>from fontTools.ttLib import TTFont


def get_font_map():
    # 这个字体文件需要先析网页，找到这个url，然后下载下来到本地，然后使用TTFont()加载字体文件 
    #       字体文件的名字
    font = TTFont(&#39;76d0609c.woff&#39;)
    # 得到cmap 字体对应代码-&gt;字体名字
    font_cmap = font.getBestCmap()
    # 得到所有的字体名字
    font_names = font.getGlyphOrder()
    # 这个文字是先使用fontCreator软件打开字体文件，然后查看到字体，从而得到的数据
    texts = [
        &#39;&#39;,&#39;&#39;,&#39;1&#39;,&#39;2&#39;,&#39;3&#39;,&#39;4&#39;,&#39;5&#39;,&#39;6&#39;,&#39;7&#39;,&#39;8&#39;,
        &#39;9&#39;,&#39;0&#39;,&#39;店&#39;,&#39;中&#39;,&#39;美&#39;,&#39;家&#39;,&#39;馆&#39;,&#39;小&#39;,&#39;车&#39;,&#39;大&#39;,
        &#39;市&#39;,&#39;公&#39;,&#39;酒&#39;,&#39;行&#39;,&#39;国&#39;,&#39;品&#39;,&#39;发&#39;,&#39;电&#39;,&#39;金&#39;,&#39;心&#39;,
        &#39;业&#39;,&#39;商&#39;,&#39;司&#39;,&#39;超&#39;,&#39;生&#39;,&#39;装&#39;,&#39;园&#39;,&#39;场&#39;,&#39;食&#39;,&#39;有&#39;,
        &#39;新&#39;,&#39;限&#39;,&#39;天&#39;,&#39;面&#39;,&#39;工&#39;,&#39;服&#39;,&#39;海&#39;,&#39;华&#39;,&#39;水&#39;,&#39;房&#39;,
        &#39;饰&#39;,&#39;城&#39;,&#39;乐&#39;,&#39;汽&#39;,&#39;香&#39;,&#39;部&#39;,&#39;利&#39;,&#39;子&#39;,&#39;老&#39;,&#39;艺&#39;,
        &#39;花&#39;,&#39;专&#39;,&#39;东&#39;,&#39;肉&#39;,&#39;菜&#39;,&#39;学&#39;,&#39;福&#39;,&#39;饭&#39;,&#39;人&#39;,&#39;百&#39;,
        &#39;餐&#39;,&#39;茶&#39;,&#39;务&#39;,&#39;通&#39;,&#39;味&#39;,&#39;所&#39;,&#39;山&#39;,&#39;区&#39;,&#39;门&#39;,&#39;药&#39;,
        &#39;银&#39;,&#39;农&#39;,&#39;龙&#39;,&#39;停&#39;,&#39;尚&#39;,&#39;安&#39;,&#39;广&#39;,&#39;鑫&#39;,&#39;一&#39;,&#39;容&#39;,
        &#39;动&#39;,&#39;南&#39;,&#39;具&#39;,&#39;源&#39;,&#39;兴&#39;,&#39;鲜&#39;,&#39;记&#39;,&#39;时&#39;,&#39;机&#39;,&#39;烤&#39;,
        &#39;文&#39;,&#39;康&#39;,&#39;信&#39;,&#39;果&#39;,&#39;阳&#39;,&#39;理&#39;,&#39;锅&#39;,&#39;宝&#39;,&#39;达&#39;,&#39;地&#39;,
        &#39;儿&#39;,&#39;衣&#39;,&#39;特&#39;,&#39;产&#39;,&#39;西&#39;,&#39;批&#39;,&#39;坊&#39;,&#39;州&#39;,&#39;牛&#39;,&#39;佳&#39;,
        &#39;化&#39;,&#39;五&#39;,&#39;米&#39;,&#39;修&#39;,&#39;爱&#39;,&#39;北&#39;,&#39;养&#39;,&#39;卖&#39;,&#39;建&#39;,&#39;材&#39;,
        &#39;三&#39;,&#39;会&#39;,&#39;鸡&#39;,&#39;室&#39;,&#39;红&#39;,&#39;站&#39;,&#39;德&#39;,&#39;王&#39;,&#39;光&#39;,&#39;名&#39;,
        &#39;丽&#39;,&#39;油&#39;,&#39;院&#39;,&#39;堂&#39;,&#39;烧&#39;,&#39;江&#39;,&#39;社&#39;,&#39;合&#39;,&#39;星&#39;,&#39;货&#39;,
        &#39;型&#39;,&#39;村&#39;,&#39;自&#39;,&#39;科&#39;,&#39;快&#39;,&#39;便&#39;,&#39;日&#39;,&#39;民&#39;,&#39;营&#39;,&#39;和&#39;,
        &#39;活&#39;,&#39;童&#39;,&#39;明&#39;,&#39;器&#39;,&#39;烟&#39;,&#39;育&#39;,&#39;宾&#39;,&#39;精&#39;,&#39;屋&#39;,&#39;经&#39;,
        &#39;居&#39;,&#39;庄&#39;,&#39;石&#39;,&#39;顺&#39;,&#39;林&#39;,&#39;尔&#39;,&#39;县&#39;,&#39;手&#39;,&#39;厅&#39;,&#39;销&#39;,
        &#39;用&#39;,&#39;好&#39;,&#39;客&#39;,&#39;火&#39;,&#39;雅&#39;,&#39;盛&#39;,&#39;体&#39;,&#39;旅&#39;,&#39;之&#39;,&#39;鞋&#39;,
        &#39;辣&#39;,&#39;作&#39;,&#39;粉&#39;,&#39;包&#39;,&#39;楼&#39;,&#39;校&#39;,&#39;鱼&#39;,&#39;平&#39;,&#39;彩&#39;,&#39;上&#39;,
        &#39;吧&#39;,&#39;保&#39;,&#39;永&#39;,&#39;万&#39;,&#39;物&#39;,&#39;教&#39;,&#39;吃&#39;,&#39;设&#39;,&#39;医&#39;,&#39;正&#39;,
        &#39;造&#39;,&#39;丰&#39;,&#39;健&#39;,&#39;点&#39;,&#39;汤&#39;,&#39;网&#39;,&#39;庆&#39;,&#39;技&#39;,&#39;斯&#39;,&#39;洗&#39;,
        &#39;料&#39;,&#39;配&#39;,&#39;汇&#39;,&#39;木&#39;,&#39;缘&#39;,&#39;加&#39;,&#39;麻&#39;,&#39;联&#39;,&#39;卫&#39;,&#39;川&#39;,
        &#39;泰&#39;,&#39;色&#39;,&#39;世&#39;,&#39;方&#39;,&#39;寓&#39;,&#39;风&#39;,&#39;幼&#39;,&#39;羊&#39;,&#39;烫&#39;,&#39;来&#39;,
        &#39;高&#39;,&#39;厂&#39;,&#39;兰&#39;,&#39;阿&#39;,&#39;贝&#39;,&#39;皮&#39;,&#39;全&#39;,&#39;女&#39;,&#39;拉&#39;,&#39;成&#39;,
        &#39;云&#39;,&#39;维&#39;,&#39;贸&#39;,&#39;道&#39;,&#39;术&#39;,&#39;运&#39;,&#39;都&#39;,&#39;口&#39;,&#39;博&#39;,&#39;河&#39;,
        &#39;瑞&#39;,&#39;宏&#39;,&#39;京&#39;,&#39;际&#39;,&#39;路&#39;,&#39;祥&#39;,&#39;青&#39;,&#39;镇&#39;,&#39;厨&#39;,&#39;培&#39;,
        &#39;力&#39;,&#39;惠&#39;,&#39;连&#39;,&#39;马&#39;,&#39;鸿&#39;,&#39;钢&#39;,&#39;训&#39;,&#39;影&#39;,&#39;甲&#39;,&#39;助&#39;,
        &#39;窗&#39;,&#39;布&#39;,&#39;富&#39;,&#39;牌&#39;,&#39;头&#39;,&#39;四&#39;,&#39;多&#39;,&#39;妆&#39;,&#39;吉&#39;,&#39;苑&#39;,
        &#39;沙&#39;,&#39;恒&#39;,&#39;隆&#39;,&#39;春&#39;,&#39;干&#39;,&#39;饼&#39;,&#39;氏&#39;,&#39;里&#39;,&#39;二&#39;,&#39;管&#39;,
        &#39;诚&#39;,&#39;制&#39;,&#39;售&#39;,&#39;嘉&#39;,&#39;长&#39;,&#39;轩&#39;,&#39;杂&#39;,&#39;副&#39;,&#39;清&#39;,&#39;计&#39;,
        &#39;黄&#39;,&#39;讯&#39;,&#39;太&#39;,&#39;鸭&#39;,&#39;号&#39;,&#39;街&#39;,&#39;交&#39;,&#39;与&#39;,&#39;叉&#39;,&#39;附&#39;,
        &#39;近&#39;,&#39;层&#39;,&#39;旁&#39;,&#39;对&#39;,&#39;巷&#39;,&#39;栋&#39;,&#39;环&#39;,&#39;省&#39;,&#39;桥&#39;,&#39;湖&#39;,
        &#39;段&#39;,&#39;乡&#39;,&#39;厦&#39;,&#39;府&#39;,&#39;铺&#39;,&#39;内&#39;,&#39;侧&#39;,&#39;元&#39;,&#39;购&#39;,&#39;前&#39;,
        &#39;幢&#39;,&#39;滨&#39;,&#39;处&#39;,&#39;向&#39;,&#39;座&#39;,&#39;下&#39;,&#39;県&#39;,&#39;凤&#39;,&#39;港&#39;,&#39;开&#39;,
        &#39;关&#39;,&#39;景&#39;,&#39;泉&#39;,&#39;塘&#39;,&#39;放&#39;,&#39;昌&#39;,&#39;线&#39;,&#39;湾&#39;,&#39;政&#39;,&#39;步&#39;,
        &#39;宁&#39;,&#39;解&#39;,&#39;白&#39;,&#39;田&#39;,&#39;町&#39;,&#39;溪&#39;,&#39;十&#39;,&#39;八&#39;,&#39;古&#39;,&#39;双&#39;,
        &#39;胜&#39;,&#39;本&#39;,&#39;单&#39;,&#39;同&#39;,&#39;九&#39;,&#39;迎&#39;,&#39;第&#39;,&#39;台&#39;,&#39;玉&#39;,&#39;锦&#39;,
        &#39;底&#39;,&#39;后&#39;,&#39;七&#39;,&#39;斜&#39;,&#39;期&#39;,&#39;武&#39;,&#39;岭&#39;,&#39;松&#39;,&#39;角&#39;,&#39;纪&#39;,
        &#39;朝&#39;,&#39;峰&#39;,&#39;六&#39;,&#39;振&#39;,&#39;珠&#39;,&#39;局&#39;,&#39;岗&#39;,&#39;洲&#39;,&#39;横&#39;,&#39;边&#39;,
        &#39;济&#39;,&#39;井&#39;,&#39;办&#39;,&#39;汉&#39;,&#39;代&#39;,&#39;临&#39;,&#39;弄&#39;,&#39;团&#39;,&#39;外&#39;,&#39;塔&#39;,
        &#39;杨&#39;,&#39;铁&#39;,&#39;浦&#39;,&#39;字&#39;,&#39;年&#39;,&#39;岛&#39;,&#39;陵&#39;,&#39;原&#39;,&#39;梅&#39;,&#39;进&#39;,
        &#39;荣&#39;,&#39;友&#39;,&#39;虹&#39;,&#39;央&#39;,&#39;桂&#39;,&#39;沿&#39;,&#39;事&#39;,&#39;津&#39;,&#39;凯&#39;,&#39;莲&#39;,
        &#39;丁&#39;,&#39;秀&#39;,&#39;柳&#39;,&#39;集&#39;,&#39;紫&#39;,&#39;旗&#39;,&#39;张&#39;,&#39;谷&#39;,&#39;的&#39;,&#39;是&#39;,
        &#39;不&#39;,&#39;了&#39;,&#39;很&#39;,&#39;还&#39;,&#39;个&#39;,&#39;也&#39;,&#39;这&#39;,&#39;我&#39;,&#39;就&#39;,&#39;在&#39;,
        &#39;以&#39;,&#39;可&#39;,&#39;到&#39;,&#39;错&#39;,&#39;没&#39;,&#39;去&#39;,&#39;过&#39;,&#39;感&#39;,&#39;次&#39;,&#39;要&#39;,
        &#39;比&#39;,&#39;觉&#39;,&#39;看&#39;,&#39;得&#39;,&#39;说&#39;,&#39;常&#39;,&#39;真&#39;,&#39;们&#39;,&#39;但&#39;,&#39;最&#39;,
        &#39;喜&#39;,&#39;哈&#39;,&#39;么&#39;,&#39;别&#39;,&#39;位&#39;,&#39;能&#39;,&#39;较&#39;,&#39;境&#39;,&#39;非&#39;,&#39;为&#39;,
        &#39;欢&#39;,&#39;然&#39;,&#39;他&#39;,&#39;挺&#39;,&#39;着&#39;,&#39;价&#39;,&#39;那&#39;,&#39;意&#39;,&#39;种&#39;,&#39;想&#39;,
        &#39;出&#39;,&#39;员&#39;,&#39;两&#39;,&#39;推&#39;,&#39;做&#39;,&#39;排&#39;,&#39;实&#39;,&#39;分&#39;,&#39;间&#39;,&#39;甜&#39;,
        &#39;度&#39;,&#39;起&#39;,&#39;满&#39;,&#39;给&#39;,&#39;热&#39;,&#39;完&#39;,&#39;格&#39;,&#39;荐&#39;,&#39;喝&#39;,&#39;等&#39;,
        &#39;其&#39;,&#39;再&#39;,&#39;几&#39;,&#39;只&#39;,&#39;现&#39;,&#39;朋&#39;,&#39;候&#39;,&#39;样&#39;,&#39;直&#39;,&#39;而&#39;,
        &#39;买&#39;,&#39;于&#39;,&#39;般&#39;,&#39;豆&#39;,&#39;量&#39;,&#39;选&#39;,&#39;奶&#39;,&#39;打&#39;,&#39;每&#39;,&#39;评&#39;,
        &#39;少&#39;,&#39;算&#39;,&#39;又&#39;,&#39;因&#39;,&#39;情&#39;,&#39;找&#39;,&#39;些&#39;,&#39;份&#39;,&#39;置&#39;,&#39;适&#39;,
        &#39;什&#39;,&#39;蛋&#39;,&#39;师&#39;,&#39;气&#39;,&#39;你&#39;,&#39;姐&#39;,&#39;棒&#39;,&#39;试&#39;,&#39;总&#39;,&#39;定&#39;,
        &#39;啊&#39;,&#39;足&#39;,&#39;级&#39;,&#39;整&#39;,&#39;带&#39;,&#39;虾&#39;,&#39;如&#39;,&#39;态&#39;,&#39;且&#39;,&#39;尝&#39;,
        &#39;主&#39;,&#39;话&#39;,&#39;强&#39;,&#39;当&#39;,&#39;更&#39;,&#39;板&#39;,&#39;知&#39;,&#39;己&#39;,&#39;无&#39;,&#39;酸&#39;,
        &#39;让&#39;,&#39;入&#39;,&#39;啦&#39;,&#39;式&#39;,&#39;笑&#39;,&#39;赞&#39;,&#39;片&#39;,&#39;酱&#39;,&#39;差&#39;,&#39;像&#39;,
        &#39;提&#39;,&#39;队&#39;,&#39;走&#39;,&#39;嫩&#39;,&#39;才&#39;,&#39;刚&#39;,&#39;午&#39;,&#39;接&#39;,&#39;重&#39;,&#39;串&#39;,
        &#39;回&#39;,&#39;晚&#39;,&#39;微&#39;,&#39;周&#39;,&#39;值&#39;,&#39;费&#39;,&#39;性&#39;,&#39;桌&#39;,&#39;拍&#39;,&#39;跟&#39;,
        &#39;块&#39;,&#39;调&#39;,&#39;糕&#39;
    ]


    font_name_map = {}


    # 将 字体名字 和 我们查看到的值 组成一个字典 
    for index,value in enumerate(texts):
        font_name_map[font_names[index]] = value


    return font_cmap,font_name_map</code></pre>
<p>这里我还是很贴心的给大家画了一个图来解释其中的对应关系。</p>
<p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理12.png" /></p>
<p>这样就得到了字体的对应关系，但是code是一个整数，而网页上显示的是<code>&amp;#xef05;&amp;#xe40e;</code>类似这样的数据，这需要几步转化下：<br />
1、将code变成16进制<br />
2、将最前面的<code>0</code>替换为<code>&amp;#</code><br />
3、在最后面添加一个<code>;</code></p>
<p>所以我们也把code按照这个规则进行转换，然后使用re模块。只要找到这样的一个code，就直接替换为文字。这样就能够拿到准确的数据了。</p>
<p>所以，我们最后的<code>get_page()</code>函数的代码如下所示</p>
<pre><code><code>def get_page(font_names_map=None,font_cmap=None):
    # 首先分析网页，找到返回评论数据的url，这个url就会直接返回评论数据了，但是urlt中的token是会变化的，只能用一会儿，我也不知道一会儿是好久,得不到数据了就换url吧
    url = &#39;http://www.dianping.com/ajax/json/shopDynamic/allReview?shopId=131013635&amp;cityId=1604&amp;shopType=10&amp;tcv=txgmn7z01d&amp;_token=eJxVj81ugkAUhd9ltp3A%2FCskXag1DQq2MmBSTReAOhIEEYg6Nn33Do1ddHXO%2Fe45yb1foPG2wMUIIYYhuOwa4AJsIUsACLrWbLjgRGBHcIdzCLJ%2FTPABhSBtVi%2FA3TCC4ICzzx6EZt5gTgUcCkMelhhLGCS%2FGc9EwKHrate2r9ertc2Tqs4rZWWn0m4Pp9rGFCNMBeXmFGAqZdRXCKOQDFgPih4YTR7a%2Fc2BecKU2lxVxu1mt0i2rD3vw6CNYhTcx6HWzlxKov0M%2BzKm%2Fn3aLWJ5edOT4UiHRfp6UEl5K1OlVpO56mS6RAvs1X5GgyjXjTOtFlGRyng226%2BPR1nwp2S9uhUfda7Go3d99jz0DL5%2FANI8Y5M%3D&amp;uuid=c59d33fd-e043-a0f5-f6e1-79ae90d14254.1565007755&amp;platform=1&amp;partner=150&amp;optimusCode=10&amp;originUrl=http%3A%2F%2Fwww.dianping.com%2Fshop%2F131013635&#39;


    # 定义模拟请求头,注意，得不到数据的时候，也要将Cookie的值进行替换
    headers = {
        &#39;User-Agent&#39;:&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36&#39;,
        &#39;Cookie&#39;: &#39;cy=8; cye=chengdu; _lxsdk_cuid=16c61bb35536e-0e2ab00cb9c2a8-c343162-144000-16c61bb35547b; _lxsdk=16c61bb35536e-0e2ab00cb9c2a8-c343162-144000-16c61bb35547b; _hc.v=c59d33fd-e043-a0f5-f6e1-79ae90d14254.1565007755; s_ViewType=10; __utmz=1.1565010551.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); _lx_utm=utm_source%3DBaidu%26utm_medium%3Dorganic; __utma=1.1978331348.1565010551.1565010551.1565161172.2; _lxsdk_s=16c70ded480-ab0-fe2-71%7C%7C2&#39;,
        &#39;Referer&#39;:&#39;http://www.dianping.com/shop/131013635&#39;,
        &#39;Connection&#39;: &#39;keep-alive&#39;,
    }


    # 使用requests库请求url，得到数据json数据
    result_json_str = requests.get(url,headers=headers).text
    # 应为返回的数据是富文本数据，所以首先我们先去掉标签
    result_json_str = re.sub(&#39;&lt;.*?&gt;&#39;,&#39;&#39;,result_json_str)


    # 遍历 字体代码-&gt;字体名字 这个字典（code 是一个数字）
    for code, name in font_cmap.items():
        try:
            # 尝试从 字体名字 -&gt; 对应值 这个字典中得到值，防止程序出现KeyError的错误
            text = font_names_map[name]
        except:
            pass
        else:
            # 分析网页信息得知，将code变成16进制，并且把最前面的0换成&amp;#，在加上一个&#39;;&#39;. 就是网页加密了的字符窜了
            # 这里就是将59322这样的值变成类似`&amp;#xef05;&amp;#xe40e;`的值
            code_str = str(hex(code)).replace(&#39;0&#39;, &#39;&amp;#&#39;, 1) + &#39;;&#39;
            print(code, code_str, name, text)
            # 将得到的加密之后的字符串进行替换为相应的数据
            # result_str = re.sub(&#39;需要替换的字符窜&#39;,&#39;替换为怎样的字符串&#39;,&#39;从这个字符串里面查找&#39;)
            result_json_str = re.sub(code_str, text, result_json_str)


    # 处理之后的数据使用json模块变成字典
    result = json.loads(result_json_str)
    # 分析得到的数据，得到我们需要的所有评论在result[&#39;reviewAllDOList&#39;]里面
    # 因为这里有可能我们别识别出来是一个爬虫了，就会返回其他的数据，比如说你没有登陆啊这样的提示。所以这个时候我们就需要改变我们的额url了。然后重新运行我们的爬虫了
    try:
        all_review = result[&#39;reviewAllDOList&#39;]
    except:
        print(result_json_str)
        raise ValueError(&#39;爬取数据失败&#39;)


    # 遍历得到的所有评论
    for review in all_review:
        # 得到用户名
        username = review[&#39;user&#39;][&#39;userNickName&#39;]
        # 得到评论内容
        content = review[&#39;reviewDataVO&#39;][&#39;reviewBody&#39;]
        # 因为我们的重点是字体反爬，所以这里我们就是简单的显示出内容就是了
        print(&#39;*&#39;*30,&#39;\n&#39;,username,&quot;:&quot;,content,&#39;\n&#39;,&#39;*&#39;*30)</code></pre>
<p>呼。。。我们终于破解了点评网的字体加密。</p>
<p>最后还有一点需要注意，因为这个程序我当天写好之后，能成功的替换相应的字符串，但是当我第二天运行程序的时候，缺不能替换了。</p>
<p>经过分析发现，原来是点评网每天（或许不是每天，每几个小时）应该都会变换字体文件，然后<code>code-&gt;name，name-&gt;形状</code>也就对应不上了，但是<code>形状-&gt;值</code>一定是对应上的，这个不会变化。</p>
<p>那么我们每次运行之前，就直接找到字体文件对应的url，然后先将这个文件下载保存到本地，再运行我们的爬虫即可。</p>
<p><strong>注意：</strong>这个字体文件的url是会变化的，也就是点评网的服务器上每个字体应该存放了好几个不同的字体文件。所以我们每次运行都需要先去找到对应的字体文件的url。</p>
<pre><code><code>from urllib.request import urlretrieve


def get_font_file():
    url = &#39;https://s3plus.meituan.net/v1/mss_73a511b8f91f43d0bdae92584ea6330b/font/c667da25.woff&#39;
    urlretrieve(url,&#39;font.woff&#39;)</code></pre>
<p>这里说一下<code>urlretrieve</code>函数的用法吧。</p>
<p><code>urlretrieve</code>：将网络上的文件下载下来，保存到本地。第一个参数为url，第二个参数为保存到本地文件的文件名。</p>
<p>使用这个函数我们可以很方便的下载网络上一些文件，图片等。<br />
最后我们来看一波运行结果吧。</p>
<p><img src="./images/破解点评网字体反爬，深入挖掘系统背后的原理13.png" /></p>
<p>不得不服点评网，反爬虫做的真是厉害。。。</p>
<p>关注公众号「<strong>Python专栏</strong>」，更多有趣好玩的Python等着你哟～</p>
<p>全部代码已上传至Github：<a href="https://github.com/MiracleYoung/You-are-Pythonista/tree/master/PythonExercise/App/dianping_spider" class="uri">https://github.com/MiracleYoung/You-are-Pythonista/tree/master/PythonExercise/App/dianping_spider</a></p>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>