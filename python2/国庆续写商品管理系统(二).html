<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修国庆续写商品管理系统(二)' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>国庆续写商品管理系统(二)</center></div><div class='banquan'>原文出处:本文由博客园博主小小咸鱼YwY提供。<br/>
原文连接:https://www.cnblogs.com/pythonywy/p/11620005.html</div><br>
    <p><code>国庆有点懒散更新的内容不多,大家国庆快乐</code></p>
<h2 id="一.做的事情">一.做的事情</h2>
<p><a href="https://www.cnblogs.com/pythonywy/p/11483157.html#4349683">上次写到点我查看</a></p>
<ul>
<li>设置中国时区</li>
<li>修改表单存储位置</li>
<li>设计商品相关的表,主要是总库存,退货,进货,销售</li>
<li>优化登入验证码,去除<code>1iO0</code>这些让人难以区分的内容</li>
<li>重新设计文件目录</li>
</ul>
<h2 id="二.配置相关">二.配置相关</h2>
<p><code>setting.py</code></p>
<pre><code><code>&quot;&quot;&quot;
Django settings for drf_test project.

Generated by &#39;django-admin startproject&#39; using Django 1.11.22.

For more information on this file, see
https://docs.djangoproject.com/en/1.11/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/1.11/ref/settings/
&quot;&quot;&quot;

import os
# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/1.11/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = &#39;ppa5l3jvxr4k^ow*4o+0_^7@&amp;sa3x+!hb_$artwraa%60iq@g7&#39;

# SECURITY WARNING: don&#39;t run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    &#39;django.contrib.admin&#39;,
    &#39;django.contrib.auth&#39;,
    &#39;django.contrib.contenttypes&#39;,
    &#39;django.contrib.sessions&#39;,
    &#39;django.contrib.messages&#39;,
    &#39;django.contrib.staticfiles&#39;,
    &#39;drf_api&#39;,
]

MIDDLEWARE = [
    &#39;django.middleware.security.SecurityMiddleware&#39;,
    &#39;django.contrib.sessions.middleware.SessionMiddleware&#39;,
    &#39;django.middleware.common.CommonMiddleware&#39;,
    # &#39;django.middleware.csrf.CsrfViewMiddleware&#39;,
    &#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;,
    &#39;django.contrib.messages.middleware.MessageMiddleware&#39;,
    &#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;,
]

ROOT_URLCONF = &#39;drf_test.urls&#39;

TEMPLATES = [
    {
        &#39;BACKEND&#39;: &#39;django.template.backends.django.DjangoTemplates&#39;,
        &#39;DIRS&#39;: [os.path.join(BASE_DIR, &#39;templates&#39;)]
        ,
        &#39;APP_DIRS&#39;: True,
        &#39;OPTIONS&#39;: {
            &#39;context_processors&#39;: [
                &#39;django.template.context_processors.debug&#39;,
                &#39;django.template.context_processors.request&#39;,
                &#39;django.contrib.auth.context_processors.auth&#39;,
                &#39;django.contrib.messages.context_processors.messages&#39;,
            ],
        },
    },
]

WSGI_APPLICATION = &#39;drf_test.wsgi.application&#39;


# Database
# https://docs.djangoproject.com/en/1.11/ref/settings/#databases

DATABASES = {
    &#39;default&#39;: {
        &#39;ENGINE&#39;: &#39;django.db.backends.mysql&#39;,   # 数据库引擎
        &#39;NAME&#39;: &#39;mib&#39;,         # 你要存储数据的库名，事先要创建之
        &#39;USER&#39;: &#39;root&#39;,         # 数据库用户名
        &#39;PASSWORD&#39;: &#39;16745&#39;,     # 密码
        &#39;HOST&#39;: &#39;localhost&#39;,    # IP
        &#39;PORT&#39;: &#39;3306&#39;,         # 数据库使用的端口
    }
}


# Password validation
# https://docs.djangoproject.com/en/1.11/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        &#39;NAME&#39;: &#39;django.contrib.auth.password_validation.UserAttributeSimilarityValidator&#39;,
    },
    {
        &#39;NAME&#39;: &#39;django.contrib.auth.password_validation.MinimumLengthValidator&#39;,
    },
    {
        &#39;NAME&#39;: &#39;django.contrib.auth.password_validation.CommonPasswordValidator&#39;,
    },
    {
        &#39;NAME&#39;: &#39;django.contrib.auth.password_validation.NumericPasswordValidator&#39;,
    },
]


# Internationalization
# https://docs.djangoproject.com/en/1.11/topics/i18n/

LANGUAGE_CODE = &#39;zh-hans&#39;

TIME_ZONE = &#39;Asia/Shanghai&#39;

USE_I18N = True

USE_L10N = True

USE_TZ = False


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/1.11/howto/static-files/

STATIC_URL = &#39;/static/&#39;
STATICFILES_DIRS=(os.path.join(BASE_DIR,&#39;static&#39;),)
AUTH_USER_MODEL = &quot;drf_api.UserInfo&quot;
MEDIA_URL  = &quot;/img/&quot;
MEDIA_ROOT = os.path.join(BASE_DIR, &quot;img&quot;)</code></pre>
<h2 id="三.验证码相关">三.验证码相关</h2>
<pre><code><code>from django.shortcuts import render,HttpResponse,redirect
from django.http import JsonResponse

from PIL import Image,ImageDraw,ImageFont
import random

from io import BytesIO

from django.contrib import auth

from drf_api.userinfo_form import Register
from drf_api import models
from rest_framework.throttling import SimpleRateThrottle


def test(request):
    return render(request, &#39;aa.html&#39;)



def register(request):
    if request.method==&#39;GET&#39;:
        form=Register()
        return render(request, &#39;register.html&#39;, {&#39;form&#39;:form})
    elif request.is_ajax():
        response={&#39;code&#39;:100,&#39;msg&#39;:None}
        form = Register(request.POST)
        if form.is_valid():
            #校验通过的数据
            clean_data=form.cleaned_data
            #把re_pwd剔除
            clean_data.pop(&#39;re_pwd&#39;)
            #取出头像
            avatar=request.FILES.get(&#39;avatar&#39;)
            if avatar:
                clean_data[&#39;avatar&#39;]=avatar
            user=models.UserInfo.objects.create_user(**clean_data)
            if user:
                response[&#39;msg&#39;] = &#39;创建成功&#39;
            else:
                response[&#39;code&#39;] = 103
                response[&#39;msg&#39;] = &#39;创建失败&#39;
        else:
            response[&#39;code&#39;]=101
            #把校验不通过的数据返回
            response[&#39;msg&#39;]=form.errors
            print(type(form.errors))
        return JsonResponse(response,safe=False)


def login(request):
    if request.method==&#39;GET&#39;:
        return render(request, &#39;login.html&#39;)
    else:
        print(request.POST)
        user_name=request.POST.get(&#39;name&#39;)
        pwd=request.POST.get(&#39;pwd&#39;)
        code=request.POST.get(&#39;code&#39;)

        user=auth.authenticate(username=user_name,password=pwd)
        print(user)
        if request.session.get(&#39;code&#39;).upper() !=code.upper(): #忽略大小写
            return HttpResponse(&#39;验证码错误&#39;)
        elif not user:
            return HttpResponse(&#39;账号密码错误&#39;)
        else:
            auth.login(request,user)
            return HttpResponse(&#39;登入成功&#39;)



def get_code(request):
    if request.method == &#39;GET&#39;:
        img = Image.new(&#39;RGB&#39;, (350, 40), (random.randint(0, 255), random.randint(0, 255), random.randint(0, 255)))
        # 写文字
        # 生成一个字体对象
        font = ImageFont.truetype(&#39;/static/Gabriola.ttf&#39;, 34)
        # 调用方法，返回一个画板对象
        draw = ImageDraw.Draw(img)

        new_text =&#39;&#39;
        x = 100
        # 生成随机8位数字
        text_chiose = &#39;zxcvbnmasdfghjklqwertyup23456789ZXCVBNMASDFGHJKLQWERTYUP&#39;
        text_list=random.sample(text_chiose,8)
        for text in text_list:
            x+=20
            y = random.randint(1,5)
            draw.text((x, y), text, (random.randint(0, 255), random.randint(0, 255), random.randint(0, 255)),
                      font=font)
            new_text +=text



        # 加点线
        width = 320
        height = 35
        for i in range(2):
            x1 = random.randint(0, width)
            x2 = random.randint(0, width)
            y1 = random.randint(0, height)
            y2 = random.randint(0, height)
            # 在图片上画线
            draw.line((x1, y1, x2, y2), fill=(random.randint(0, 255), random.randint(0, 255), random.randint(0, 255)))

        for i in range(10):
            # 画点
            draw.point([random.randint(0, width), random.randint(0, height)], fill=(random.randint(0, 255), random.randint(0, 255), random.randint(0, 255)))
            x = random.randint(0, width)
            y = random.randint(0, height)
            # 画弧形
            draw.arc((x, y, x + 4, y + 4), 0, 90, fill=(random.randint(0, 255), random.randint(0, 255), random.randint(0, 255)))
        print(new_text)
        #存在session中
        request.session[&#39;code&#39;]=new_text
        #存内存
        f = BytesIO()
        img.save(f, &#39;png&#39;)
        return HttpResponse(f.getvalue())</code></pre>
<h2 id="四.模型相关">四.模型相关</h2>
<pre><code><code>from django.db import models
from django.contrib.auth.models import AbstractUser

from rest_framework import mixins
# Create your models here.
class UserInfo(AbstractUser):
    avatar = models.FileField(upload_to=&#39;avatar/&#39;, default=&#39;avatar/default.png&#39;)
    class Meta:
        verbose_name=&#39;用户表&#39;
        verbose_name_plural = verbose_name


class  Commodity(models.Model):
    id = models.SmallIntegerField(primary_key=True,db_column=&#39;序号&#39;)
    name = models.CharField(max_length=60,db_column=&#39;商品名&#39;,null=True)
    inventory = models.IntegerField(db_column=&#39;库存&#39;,null=True)
    cost = models.DecimalField (max_digits=60,decimal_places=2,db_column=&#39;单件成本&#39;,null=True)
    selling_price= models.DecimalField (max_digits=60,decimal_places=2,db_column=&#39;销售价格&#39;,null=True)
    quantity_in = models.IntegerField(db_column=&#39;进货总数量&#39;,null=True)
    sales_volume = models.IntegerField(db_column=&#39;销售量总数量&#39;,null=True)
    return_volume = models.IntegerField(db_column=&#39;退货总数量&#39;,null=True)
    is_delete = models.BooleanField(default=False, db_column=&#39;是否删除&#39;)
    def __str__(self):
        return self.name

    class Meta:
        db_table = &quot;库存表&quot;


class DaySales(models.Model):
    id = models.SmallIntegerField(primary_key=True, db_column=&#39;日期序号&#39;)
    date = models.DateTimeField(auto_now_add=True,db_column=&#39;日期&#39;)
    number = models.DecimalField(max_digits=60, decimal_places=2, db_column=&#39;营业总额&#39;, null=True)
    is_delete = models.BooleanField(default=False, db_column=&#39;是否删除&#39;)
    date_changed = models.DateTimeField(auto_now=True,db_column=&#39;最后修改日期&#39;)
    def __str__(self):
        return self.date
    class Meta:
        db_table = &quot;日销售表&quot;

class DayStock(models.Model):
    id = models.SmallIntegerField(primary_key=True, db_column=&#39;日期序号&#39;)
    date = models.DateTimeField(auto_now_add=True,db_column=&#39;日期&#39;)
    number  = models.DecimalField(max_digits=60, decimal_places=2, db_column=&#39;进货总额&#39;, null=True)
    is_delete = models.BooleanField(default=False, db_column=&#39;是否删除&#39;)
    date_changed = models.DateTimeField(auto_now=True,db_column=&#39;最后修改日期&#39;)
    def __str__(self):
        return self.date
    class Meta:
        db_table = &quot;日进货表&quot;

class DayReturn(models.Model):
    id = models.SmallIntegerField(primary_key=True, db_column=&#39;日期序号&#39;)
    date = models.DateTimeField(auto_now_add=True,db_column=&#39;日期&#39;)
    number  = models.DecimalField(max_digits=60, decimal_places=2, db_column=&#39;退货总额&#39;, null=True)
    is_delete = models.BooleanField(default=False, db_column=&#39;是否删除&#39;)
    date_changed = models.DateTimeField(auto_now=True,db_column=&#39;最后修改日期&#39;)
    def __str__(self):
        return self.date
    class Meta:
        db_table = &quot;日退货表&quot;


class CommoditySales(models.Model):
    id = models.SmallIntegerField(primary_key=True, db_column=&#39;日期序号&#39;)
    name = models.CharField(max_length=60,db_column=&#39;商品名&#39;,null=True)
    data = models.ForeignKey(&#39;DaySales&#39;,&#39;id&#39;,db_column=&#39;销售日期&#39;,null=True)
    selling_price= models.DecimalField (max_digits=60,decimal_places=2,db_column=&#39;销售价格&#39;,null=True)
    sales_volume = models.IntegerField(db_column=&#39;销售量数量&#39;,null=True)
    batch = models.IntegerField(db_column=&#39;批号&#39;,null=True)
    is_delete = models.BooleanField(default=False, db_column=&#39;是否删除&#39;)
    date_changed = models.DateTimeField(auto_now=True,db_column=&#39;最后修改日期&#39;)
    def __str__(self):
        return self.name
    class Meta:
        db_table = &quot;商品销售表&quot;


class CommodityStock(models.Model):
    id = models.SmallIntegerField(primary_key=True, db_column=&#39;日期序号&#39;)
    name = models.CharField(max_length=60,db_column=&#39;商品名&#39;,null=True)
    data = models.ForeignKey(&#39;DayStock&#39;,&#39;id&#39;,db_column=&#39;进货日期&#39;,null=True)
    cost = models.DecimalField (max_digits=60,decimal_places=2,db_column=&#39;单件成本&#39;,null=True)
    Stock_volume = models.IntegerField( db_column=&#39;进货数量&#39;, null=True)
    batch = models.IntegerField(db_column=&#39;批号&#39;,null=True)
    is_delete = models.BooleanField(default=False, db_column=&#39;是否删除&#39;)
    date_changed = models.DateTimeField(auto_now=True,db_column=&#39;最后修改日期&#39;)
    def __str__(self):
        return self.name
    class Meta:
        db_table = &quot;商品进货表&quot;

class CommodityReturn(models.Model):
    id = models.SmallIntegerField(primary_key=True, db_column=&#39;日期序号&#39;)
    name = models.CharField(max_length=60,db_column=&#39;商品名&#39;,null=True)
    data = models.ForeignKey(&#39;DayReturn&#39;,&#39;id&#39;,db_column=&#39;退货日期&#39;,null=True)
    cost = models.DecimalField (max_digits=60,decimal_places=2,db_column=&#39;退货价格&#39;,null=True)
    return_volume = models.IntegerField( db_column=&#39;退货数量&#39;, null=True)
    batch = models.IntegerField(db_column=&#39;批号&#39;,null=True)
    is_delete = models.BooleanField(default=False, db_column=&#39;是否删除&#39;)
    date_changed = models.DateTimeField(auto_now=True,db_column=&#39;最后修改日期&#39;)
    def __str__(self):
        return self.name
    class Meta:
        db_table = &quot;商品退货表&quot;</code></pre>

</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>