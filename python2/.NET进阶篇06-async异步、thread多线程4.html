<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修.NET进阶篇06-async异步、thread多线程4' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>.NET进阶篇06-async异步、thread多线程4</center></div><div class='banquan'>原文出处:本文由博客园博主那是山提供。<br/>
原文连接:https://www.cnblogs.com/xibei/p/12001805.html</div><br>
    <div id="output_wrapper_id" class="output_wrapper" style="font-size: 16px; color: #3e3e3e; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; font-family: 'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;">
<blockquote style="line-height: inherit; display: block; padding: 15px 15px 15px 1rem; font-size: 0.9em; margin: 1em 0px; color: #819198; border-left: 6px solid #dce6f0; background: #f2f7fb; overflow: auto; word-wrap: normal; word-break: normal;">
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0px;">知识需要不断积累、总结和沉淀，思考和写作是成长的催化剂</p>
</blockquote>
<h3 id="h" style="color: inherit; line-height: inherit; font-weight: bold; font-size: 1.3em; border-left: 5px solid #00acc1; padding: 3px; background: #f9f9f9; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; display: inline-block; padding: 3px 10px 0px; border-top-right-radius: 3px; border-top-left-radius: 4px; margin-right: 2px;">梯子</span></h3>
<p id="tocid_0" class="toc" style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px; margin-left: 25px;"><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h-1">一、锁</a></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h1lock">1、lock</a></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h2interlocked">2、Interlocked</a></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h3monitor">3、Monitor</a></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h4spinlock">4、SpinLock</a></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h5mutex">5、Mutex</a></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h6semaphore">6、Semaphore</a></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h7events">7、Events</a></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h1autoresetevent">1、AutoResetEvent</a></span></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h2manualresetevent">2、ManualResetEvent</a></span></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h3manualreseteventslim">3、ManualResetEventSlim</a></span></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h8readerwriterlock">8、ReaderWriterLock</a></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h-2">二、线程安全集合</a></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h-3">三、多线程模型</a></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h1spm">1、同步编程模型SPM</a></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h2apm">2、异步编程模型APM</a></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h3eap">3、基于事件编程模型EAP</a></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#h4tap">4、基于任务编程模型TAP</a></span></span></span><span class="toc_item" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: block;"><span class="toc_left" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; margin-left: 25px;"><a style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; text-decoration: none; color: #1e6bb8; word-wrap: break-word;" href="#hend">四、End</a></span></span></p>
<h3 id="h-1" style="color: inherit; line-height: inherit; font-weight: bold; font-size: 1.3em; border-left: 5px solid #00acc1; padding: 3px; background: #f9f9f9; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; display: inline-block; padding: 3px 10px 0px; border-top-right-radius: 3px; border-top-left-radius: 4px; margin-right: 2px;">一、锁</span></h3>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">数据库中也有锁概念，行锁，表锁，事物锁等，锁的作用就是<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;"><code>控制并发情况下数据的安全一致</code></strong>，使一个数据被操作时，其他并发线程等待。开发方面多线程并行编程访问共享数据时，为保证数据的一致安全，有时需要使用锁来锁定对象来达到同步</p>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">.NET中提供很多线程同步技术。有lock，Interlocked，Monitor等用于进程内同步锁，Mutex互斥锁，Semaphore信号量，Events，ReaderWriterLockSlim读写锁等用于多个进程间的线程同步</p>
<h4 id="h1lock" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1.2em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">1、lock</span></h4>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">lock语句是设置对锁定和解除锁定的一种简单方式，也是最常用的一种同步方式。lock用于锁定一个<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;"><code>引用类型字段</code></strong>，当线程执行到Lock处，会锁定该字段，使之只有一个线程进入lock语句块内，才lock语句结束位置再释放锁定，另一个线程才可以进入。原理运用同步块索引，感兴趣可以研究下</p>
<pre><code><code class="csharp language-csharp hljs" style="line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; margin: 0.8em; overflow-x: auto; background: #efecf4; color: #585260; padding: 0.5em; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">lock</span>&nbsp;(obj)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//synchronized&nbsp;region</span><br />}<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">因为只有一个线程可以进去，没有并发，所以牺牲了性能，所以要尽量<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;"><code>缩小lock的范围</code></strong>，另一个建议是首选锁一个私有变量，也就是<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;"><code>SyncRoot模式</code></strong>，声明一个syncRoot的私有object变量来进行锁定，而不是使用lock(this)，因为外面调用者也可能锁定你这个对象的实例，但他并不知道你内部也使用了锁，所以容易造成死锁</p>
<pre><code><code class="hljs cs" style="line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; margin: 0.8em; overflow-x: auto; background: #efecf4; color: #585260; padding: 0.5em; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">private</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">object</span>&nbsp;syscRoot&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">object</span>();<br /><span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">public</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">void</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #576ddb; word-wrap: inherit !important; word-break: inherit !important;">DoThis</span>()<br /></span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">lock</span>&nbsp;(syscRoot)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//同一个时间只有一个线程能到达这里</span><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /></code></pre>
<h4 id="h2interlocked" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1.2em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">2、Interlocked</span></h4>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">InterLoacked用于将变量的一些简单操作原子化，也就是线程安全同步。我们常写的i++就不是线程安全的，从内存中取值然后+1然后放回内存中，过程中很可能被其他线程打断，比如在你+1后放回内存时，另一个线程已经先放回去了，也就不同步了。InerLocked类提供了以<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;"><code>线程安全的方式递增、递减、交换、读取值的方法</code></strong><br />比如以下代替lock的递增方式</p>
<pre><code><code class="hljs dart" style="line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; margin: 0.8em; overflow-x: auto; background: #efecf4; color: #585260; padding: 0.5em; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-built_in" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">int</span>&nbsp;<span class="hljs-built_in" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">num</span>&nbsp;=&nbsp;<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">0</span>;<br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//lock&nbsp;(syscRoot)</span><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//{</span><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;&nbsp;&nbsp;&nbsp;num++;</span><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//}</span><br /><span class="hljs-built_in" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">num</span>&nbsp;=&nbsp;Interlocked.Increment(ref&nbsp;<span class="hljs-built_in" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">num</span>);<br /></code></pre>
<h4 id="h3monitor" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1.2em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">3、Monitor</span></h4>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">上面lock就是Monitor的语法糖，通过编译器编译会生成Monitor的代码，像下面这样</p>
<pre><code><code class="csharp language-csharp hljs" style="line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; margin: 0.8em; overflow-x: auto; background: #efecf4; color: #585260; padding: 0.5em; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">lock</span>&nbsp;(syscRoot)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//synchronized&nbsp;region</span><br />}<br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//上面的lock锁等同于下面Monitor</span><br />Monitor.Enter(syscRoot);<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">try</span><br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//synchronized&nbsp;region</span><br />}<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">finally</span><br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;Monitor.Exit(syscRoot);<br />}<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">Monitor不同于Lock就是它还可以设置超时时间，不会无限制的等待下去。</p>
<pre><code><code class="csharp language-csharp hljs" style="line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; margin: 0.8em; overflow-x: auto; background: #efecf4; color: #585260; padding: 0.5em; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">bool</span>&nbsp;lockTaken&nbsp;=&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">false</span>;<br />Monitor.TryEnter(syscRoot,<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">500</span>,<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">ref</span>&nbsp;lockTaken);<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(lockTaken)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">try</span><br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//synchronized&nbsp;region</span><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">finally</span><br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Monitor.Exit(syscRoot);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">else</span><br />{<br />}<br /></code></pre>
<h4 id="h4spinlock" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1.2em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">4、SpinLock</span></h4>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">SpinLock自旋锁是一种用户模式锁。对了，插一嘴<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;"><code>锁分为内核模式锁和用户模式锁</code></strong>，内核模式就是在系统级别让线程中断，收到信号时再切回来继续干活，用户模式就是通过一些cpu指定或则死循环让线程一直运行着直到可用。各有优缺点吧，内核Cpu资源利用率高，但切换损耗，用户模式就相反，如果锁定时间较长，就会白白循环等待，后面就有混合模式锁的出现了</p>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">如果有大量的锁定，且锁定时间非常短，SpinLock就很有用，用法和Monitor类似，Enter或TryEnter获取锁，Exit释放锁。IsHeld和IsHeldByCurrentThread指定它当前是否锁定</p>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">另外SpinLock是个结构类型，所以注意拷贝赋值时会创建全新副本问题。必要时可按引用来传递</p>
<h4 id="h5mutex" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1.2em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">5、Mutex</span></h4>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">Mutex互斥锁提供跨多个进程同步一个类，定义互斥锁的时候可以指定互斥锁的名称，这样系统能够识别，所以在另一个进程中定义的互斥，其他进程也是可以访问到的，Mutex.OpenExisting()便可以得到。</p>
<pre><code><code class="csharp language-csharp hljs" style="line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; margin: 0.8em; overflow-x: auto; background: #efecf4; color: #585260; padding: 0.5em; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">bool</span>&nbsp;createdNew&nbsp;=&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">false</span>;<br />Mutex&nbsp;mutex&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;Mutex(<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">false</span>,&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #2a9292; word-wrap: inherit !important; word-break: inherit !important;">"ProCharpMutex"</span>,&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">out</span>&nbsp;createdNew);<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(mutex.WaitOne())<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">try</span><br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//synchronized&nbsp;region</span><br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">finally</span><br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mutex.ReleaseMutex();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">介于此我们可以用来禁止一个应用程序启动两次，一般我们通过进程的名称来判断，这里我们使用Mutex实现</p>
<pre><code><code class="csharp language-csharp hljs" style="line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; margin: 0.8em; overflow-x: auto; background: #efecf4; color: #585260; padding: 0.5em; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">bool</span>&nbsp;createdNew&nbsp;=&nbsp;<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">false</span>;<br />Mutex&nbsp;mutex&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;Mutex(<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">false</span>,&nbsp;<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #2a9292; word-wrap: inherit !important; word-break: inherit !important;">"SingletonWinAppMutex"</span>,&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">out</span>&nbsp;createdNew);<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(!createdNew)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;MessageBox.Show(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #2a9292; word-wrap: inherit !important; word-break: inherit !important;">"应用程序已经启动过了"</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;Application.Exit();<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">return</span>;<br />}<br /></code></pre>
<h4 id="h6semaphore" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1.2em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">6、Semaphore</span></h4>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">Semaphore信号量和互斥类似，区别是，信号量可以同时让<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;"><code>多个线程使用</code></strong>，是一种计数的互斥锁定。通过计数允许同时有几个线程访问受保护的资源。也可以指定信号量名称以使在多个进程间共享</p>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">Semaphore和上面Mutex都是继承自WaitHandle基类，WaitHandle用于等待一个信号的设置，嗲用Wait，线程会等待接收一个与等待句柄相关的信号</p>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">SemaphoreSlim是对Semaphore的轻量替代版本(它不继承WaitHandle)，SemaphoreSlim(int initialCount, int maxCount)构造函数可指定最大并发个数，然后在线程内通过SemaphoreSlim的Wait等到直到来接收信号是否可以进去受保护代码块了，最后记得要Release，不然下一个线程获取不到准许进入的信号</p>
<h4 id="h7events" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1.2em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">7、Events</span></h4>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">Events事件锁不同于委托中的事件，在System.Threading命名空间下，用于系统范围内的事件资源的同步，有AutoResetEvent自动事件锁、ManualResetEvent手动事件锁以及轻量版本ManualResetEventSlim</p>
<h5 id="h1autoresetevent" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">1、AutoResetEvent</span></h5>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">AutoResetEvent也是继承自waitHandle类的，也是通过WaitOne来等待直到有信号，它有两种状态：<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;"><code>终止和非终止</code></strong>，可以调用set和reset方法使对象进入终止和非终止状态。通俗点就是set有信号，另一个线程可以进入了，reset非终止无信息，其他线程就阻塞了。自动的意思就是一个线程进入了，自动Reset设置无信号了其他线程就进不去了。类似现实中的汽车收费口，一杆一车模式</p>
<pre><code><code class="csharp language-csharp hljs" style="line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; margin: 0.8em; overflow-x: auto; background: #efecf4; color: #585260; padding: 0.5em; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">private</span>&nbsp;AutoResetEvent&nbsp;autoEvent&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;AutoResetEvent(<span class="hljs-literal" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">false</span>);<br /><span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">public</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">void</span>&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #576ddb; word-wrap: inherit !important; word-break: inherit !important;">DoThis</span>()<br /></span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;autoEvent.WaitOne();<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//执行同步代码块</span><br />&nbsp;&nbsp;&nbsp;&nbsp;autoEvent.Set();<br />}<br /></code></pre>
<h5 style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"><img src="./images/.NET进阶篇06-async异步、thread多线程40.png" alt="" /></span></h5>
<h5 id="h2manualresetevent" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">2、ManualResetEvent</span></h5>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">手动事件锁和自动的区别在于，手动事件锁没有信号时会阻塞一批线程的，有信号时，所有线程都运行，同时唤醒多个线程，除非手动Reset再阻塞，类似现实场景中火车道路口的栅栏，落杆拦截一批人，起杆则一批人蜂拥通过，用法和上面一样，WaitOne等待信号，结束时通过Set来通知有信号了，可以通过了</p>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;"><img src="./images/.NET进阶篇06-async异步、thread多线程41.png" alt="" /></p>
<h5 id="h3manualreseteventslim" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">3、ManualResetEventSlim</span></h5>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">ManualResetEventSlim通过封装 ManualResetEvent提供了自旋等待和内核等待的混合锁模式。如果需要跨进程或者跨AppDomain的同步，那么就必须使用ManualResetEvent。ManualResetEventSlim使用Wait来阻塞线程，支持任务的取消。和SemaphoreSlim的Wait一样，内部<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;"><code>先通过用户模式自旋然后再通过内核模式效率更高</code></strong>。</p>
<h4 id="h8readerwriterlock" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1.2em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">8、ReaderWriterLock</span></h4>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">ReaderWriterLock读写锁不是从限定线程个数的角度来保护资源，而是按<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;"><code>读写角度</code></strong>来区分，就是你可以锁定当某一类线程（写线程）中一个进入受保护资源时，另一类线程（读线程）全部阻塞。如果没有写入线程锁定资源，就允许多个读取线程方法资源，但只能有一个写入线程锁定该资源</p>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">具体用法参考示例</p>
<pre><code><code class="csharp language-csharp hljs" style="line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; margin: 0.8em; overflow-x: auto; background: #efecf4; color: #585260; padding: 0.5em; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;"><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;创建读写锁</span><br />ReaderWriterLock&nbsp;rwLock&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;ReaderWriterLock();<br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;当前线程获取读锁，参数为：超时值（毫秒）</span><br />rwLock.AcquireReaderLock(<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">250</span>);<br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;判断当前线程是否持有读锁</span><br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(!rwLock.IsReaderLockHeld)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">return</span>;<br />}<br />Console.WriteLine(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #2a9292; word-wrap: inherit !important; word-break: inherit !important;">"拿到了读锁......"</span>);<br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;将读锁升级为写锁，锁参数为：超时值（毫秒）</span><br />LockCookie&nbsp;cookie&nbsp;=&nbsp;rwLock.UpgradeToWriterLock(<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">250</span>);<br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;判断当前线程是否持有写锁</span><br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(rwLock.IsWriterLockHeld)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #2a9292; word-wrap: inherit !important; word-break: inherit !important;">"升级到了写锁......"</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;将锁还原到之前所的级别，也就是读锁</span><br />&nbsp;&nbsp;&nbsp;&nbsp;rwLock.DowngradeFromWriterLock(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">ref</span>&nbsp;cookie);<br />}<br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;释放读锁（减少锁计数，直到计数达到零时，锁被释放）</span><br />rwLock.ReleaseReaderLock();<br />Console.WriteLine(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #2a9292; word-wrap: inherit !important; word-break: inherit !important;">"顺利执行完毕......"</span>);<br /><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;当前线程获取写锁，参数为：超时值（毫秒）</span><br />rwLock.AcquireWriterLock(<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">250</span>);<br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;判断当前线程是否持有写锁</span><br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">if</span>&nbsp;(rwLock.IsWriterLockHeld)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #2a9292; word-wrap: inherit !important; word-break: inherit !important;">"拿到了写锁......"</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;释放写锁（将减少写锁计数，直到计数变为零，释放锁）</span><br />&nbsp;&nbsp;&nbsp;&nbsp;rwLock.ReleaseWriterLock();<br />}<br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;释放写锁（将减少写锁计数，直到计数变为零，释放锁）</span><br /><span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//&nbsp;当前线程不持有锁，会抛出异常</span><br />rwLock.ReleaseWriterLock();<br />Console.WriteLine(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #2a9292; word-wrap: inherit !important; word-break: inherit !important;">"顺利执行完毕......"</span>);<br />Console.ReadLine();<br /></code></pre>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;"><strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;"><code>ReaderWriterLockSlim</code></strong>同样是ReaderWriterLock的轻量优化版本，简化了递归、升级和降级锁定状态的规则。<br />    1. EnterWriteLock   进入写模式锁定状态<br />    2. EnterReadLock    进入读模式锁定状态<br />    3. EnterUpgradeableReadLock  进入可升级的读模式锁定状态<br />并且三种锁定模式都有超时机制、对应 Try&hellip; 方法，退出相应的模式则使用 Exit&hellip; 方法，而且所有的方法都必须是成对出现的</p>
<h3 id="h-2" style="color: inherit; line-height: inherit; font-weight: bold; font-size: 1.3em; border-left: 5px solid #00acc1; padding: 3px; background: #f9f9f9; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; display: inline-block; padding: 3px 10px 0px; border-top-right-radius: 3px; border-top-left-radius: 4px; margin-right: 2px;">二、线程安全集合</span></h3>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">并行环境下修改共享变量为了保证资源安全，通常使用上面介绍的锁或信号量来解决此问题。其实.NET也内置了一些线程安全的集合，使用他们就像使用单线程集合一样。</p>
<table style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; display: table; width: 100%; text-align: left;">
<thead style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">
<tr style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-right-style: initial; border-bottom-style: initial; border-left-style: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-image: initial; border-top-style: solid; border-top-color: #cccccc; background-color: white;"><th style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left; font-weight: bold; background-color: #f0f0f0;">类型</th><th style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left; font-weight: bold; background-color: #f0f0f0;">描述</th>
</tr>

</thead>
<tbody style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; border: 0px;">
<tr style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-right-style: initial; border-bottom-style: initial; border-left-style: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-image: initial; border-top-style: solid; border-top-color: #cccccc; background-color: white;">
<td style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left;">BlockingCollection</td>
<td style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left;">提供针对实现 IProducerConsumerCollection 的任何类型的限制和阻塞功能。 有关详细信息，请参阅BlockingCollection 概述。</td>

</tr>
<tr style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-right-style: initial; border-bottom-style: initial; border-left-style: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-image: initial; border-top-style: solid; border-top-color: #cccccc; background-color: white;">
<td style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left;">ConcurrentDictionary&lt;tkey,tvalue style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;"&gt;</td>
<td style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left;">键/值对字典的线程安全实现。</td>

</tr>
<tr style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-right-style: initial; border-bottom-style: initial; border-left-style: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-image: initial; border-top-style: solid; border-top-color: #cccccc; background-color: white;">
<td style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left;">ConcurrentQueue</td>
<td style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left;">FIFO（先进先出）队列的线程安全实现。</td>

</tr>
<tr style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-right-style: initial; border-bottom-style: initial; border-left-style: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-image: initial; border-top-style: solid; border-top-color: #cccccc; background-color: white;">
<td style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left;">ConcurrentStack</td>
<td style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left;">LIFO（后进先出）堆栈的线程安全实现。</td>

</tr>
<tr style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-right-style: initial; border-bottom-style: initial; border-left-style: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-image: initial; border-top-style: solid; border-top-color: #cccccc; background-color: white;">
<td style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left;">ConcurrentBag</td>
<td style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left;">无序的元素集合的线程安全实现。</td>

</tr>
<tr style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; border-width: 1px 0px 0px; border-right-style: initial; border-bottom-style: initial; border-left-style: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-image: initial; border-top-style: solid; border-top-color: #cccccc; background-color: white;">
<td style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left;">IProducerConsumerCollection</td>
<td style="color: inherit; line-height: inherit; margin: 0px; font-size: 1em; border: 1px solid #cccccc; padding: 0.5em 1em; text-align: left;">类型必须实现以在 BlockingCollection 中使用的接口。</td>

</tr>

</tbody>

</table>
<h3 id="h-3" style="color: inherit; line-height: inherit; font-weight: bold; font-size: 1.3em; border-left: 5px solid #00acc1; padding: 3px; background: #f9f9f9; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; display: inline-block; padding: 3px 10px 0px; border-top-right-radius: 3px; border-top-left-radius: 4px; margin-right: 2px;">三、多线程模型</span></h3>
<h4 id="h1spm" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1.2em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">1、同步编程模型SPM</span></h4>
<h4 id="h2apm" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1.2em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">2、异步编程模型APM</span></h4>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">我们常见的<strong style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; font-weight: bold;"><code>XXBegin， XXEnd</code></strong>这两个经典的配对方法就是异步的，Begin后会委托给线程池调用一个线程去执行。还有委托的BeginInvoke调用</p>
<pre><code><code class="csharp language-csharp hljs" style="line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; margin: 0.8em; overflow-x: auto; background: #efecf4; color: #585260; padding: 0.5em; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;">FileStream&nbsp;fs&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;FileStream(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #2a9292; word-wrap: inherit !important; word-break: inherit !important;">"D:\\test.txt"</span>,&nbsp;FileMode.Open);<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">var</span>&nbsp;bytes&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">byte</span>[fs.Length];<br />fs.BeginRead(bytes,&nbsp;<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">0</span>,&nbsp;bytes.Length,&nbsp;(aysc)&nbsp;=&gt;<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">var</span>&nbsp;num&nbsp;=&nbsp;fs.EndRead(aysc);<br />},&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">string</span>.Empty);<br /></code></pre>
<h4 id="h3eap" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1.2em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">3、基于事件编程模型EAP</span></h4>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">WinFrom/WPF开发中的BackgroundWorker类就是异步事件模式的一种实现方案，RunWorkerAsync方法启动与DoWork事件异步关联的方法，工作完成后，就触发RunWorkerCompleted事件，也支持CancelAysnc方法取消以及ReportProgress通知进度等。还又一个典型的就是WebClient</p>
<pre><code><code class="csharp language-csharp hljs" style="line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; margin: 0.8em; overflow-x: auto; background: #efecf4; color: #585260; padding: 0.5em; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;">WebClient&nbsp;client&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;WebClient();<br />client.DownloadDataCompleted&nbsp;+=&nbsp;(sender,e)=&gt;&nbsp;<br />{<br />};<br />client.DownloadDataAsync(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;Uri(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #2a9292; word-wrap: inherit !important; word-break: inherit !important;">"https://www.baidu.com/"</span>));<br /></code></pre>
<h4 id="h4tap" style="color: inherit; line-height: inherit; padding: 0px; font-weight: bold; font-size: 1.2em; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;">4、基于任务编程模型TAP</span></h4>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">Task出来后，微软就大力推广基于Task的异步编程模型，APM和EAP都被包装成Task使用。下面示例简单用Task封装上面的编程模型。WebClient的DownloadDataTaskAsync实现和示例中的类似，利用一个TaskCompletionSource包装器包装成Task</p>
<pre><code><code class="csharp language-csharp hljs" style="line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px; font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px; margin: 0.8em; overflow-x: auto; background: #efecf4; color: #585260; padding: 0.5em; white-space: pre !important; word-wrap: normal !important; word-break: normal !important; overflow: auto !important; display: -webkit-box !important;">FileStream&nbsp;fs&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;FileStream(<span class="hljs-string" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #2a9292; word-wrap: inherit !important; word-break: inherit !important;">"D:\\test.txt"</span>,&nbsp;FileMode.Open);<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">var</span>&nbsp;bytes&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">byte</span>[fs.Length];<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">var</span>&nbsp;task&nbsp;=&nbsp;Task.Factory.FromAsync(fs.BeginRead,&nbsp;fs.EndRead,&nbsp;bytes,&nbsp;<span class="hljs-number" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;">0</span>,&nbsp;bytes.Length,&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">string</span>.Empty);<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">var</span>&nbsp;nums&nbsp;=&nbsp;task.Result;<br /><br />Action&nbsp;action&nbsp;=&nbsp;()&nbsp;=&gt;{&nbsp;};<br /><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">var</span>&nbsp;task&nbsp;=&nbsp;Task.Factory.FromAsync(action.BeginInvoke,&nbsp;action.EndInvoke,&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">string</span>.Empty);<br /><br /><span class="hljs-function" style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">public</span>&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">static</span>&nbsp;Task&lt;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">int</span>&gt;&nbsp;<span class="hljs-title" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #576ddb; word-wrap: inherit !important; word-break: inherit !important;">GetTaskAsuc</span>(<span class="hljs-params" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #aa573c; word-wrap: inherit !important; word-break: inherit !important;"><span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">string</span>&nbsp;url</span>)<br /></span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;TaskCompletionSource&lt;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">int</span>&gt;&nbsp;source&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;TaskCompletionSource&lt;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">int</span>&gt;();<span class="hljs-comment" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #655f6d; word-wrap: inherit !important; word-break: inherit !important;">//包装器</span><br />&nbsp;&nbsp;&nbsp;&nbsp;WebClient&nbsp;client&nbsp;=&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;WebClient();<br />&nbsp;&nbsp;&nbsp;&nbsp;client.DownloadDataCompleted&nbsp;+=&nbsp;(sender,&nbsp;e)&nbsp;=&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">try</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source.TrySetResult(e.Result.Length);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">catch</span>&nbsp;(Exception&nbsp;ex)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source.TrySetException(ex);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;client.DownloadDataAsync(<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">new</span>&nbsp;Uri(url));<br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="font-size: inherit; line-height: inherit; margin: 0px; padding: 0px; color: #955ae7; word-wrap: inherit !important; word-break: inherit !important;">return</span>&nbsp;source.Task;<br />}<br /></code></pre>
<h3 id="hend" style="color: inherit; line-height: inherit; font-weight: bold; font-size: 1.3em; border-left: 5px solid #00acc1; padding: 3px; background: #f9f9f9; margin: 0px;"><span style="font-size: inherit; color: inherit; line-height: inherit; margin: 0px; display: inline-block; padding: 3px 10px 0px; border-top-right-radius: 3px; border-top-left-radius: 4px; margin-right: 2px;">四、End</span></h3>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px;">最近几篇介绍了如何编写多线程和多任务应用程序。在应用程序开发过程中要仔细规划，太多的线程导致资源问题，太少则起不到大效果。多线程编程中一个中肯的建议就是<br />尽量避免修改共享变量，使同步的要求变低。通过合理规划可以减少大部分的同步复杂度。</p>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px; text-align: center;">Search the fucking web<br />Read the fucking maunal</p>
<p style="font-size: inherit; color: inherit; line-height: inherit; padding: 0px; margin: 0.8em 0px; text-align: right;">&mdash;&mdash;GoodGoodStudy</p>
</div>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>