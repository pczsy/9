<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修python uiautomator2 watcher的使用方法' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>python uiautomator2 watcher的使用方法</center></div><div class='banquan'>原文出处:本文由博客园博主aziji提供。<br/>
原文连接:https://www.cnblogs.com/aziji/p/11491703.html</div><br>
    <p>该方是基于uiautomator2如下版本进行验证的：</p>
<div class="cnblogs_Highlighter">
<pre><code>PS C:\windows\system32&gt; pip show uiautomator2
Name: uiautomator2
Version: 1.2.2
Summary: Python Wrapper for Android UiAutomator2 test tool
Home-page: https://github.com/codeskyblue/uiautomator2
Author: codeskyblue
Author-email: codeskyblue@gmail.com
License: MIT
Location: c:\program files\python36\lib\site-packages
Requires: six, progress, whichcraft, logzero, lxml, adbutils, retry, Pillow, requests, humanize
Required-by: weditor, atx
</pre>
</div>
<p>　　下面贴出githup上关于该方法的使用</p>
<div class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #000000;">Watcher
</span><span style="color: #008080;"> 2</span> You can register watchers to perform some actions when a selector does <span style="color: #0000ff;">not</span><span style="color: #000000;"> find a match.
</span><span style="color: #008080;"> 3</span> 
<span style="color: #008080;"> 4</span> <span style="color: #000000;">Register Watcher
</span><span style="color: #008080;"> 5</span> 
<span style="color: #008080;"> 6</span> When a selector can <span style="color: #0000ff;">not</span><span style="color: #000000;"> find a match, uiautomator2 will run all registered watchers.
</span><span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span> <span style="color: #000000;">Click target when conditions match
</span><span style="color: #008080;"> 9</span> d.watcher(<span style="color: #800000;">"</span><span style="color: #800000;">AUTO_FC_WHEN_ANR</span><span style="color: #800000;">"</span>).when(text=<span style="color: #800000;">"</span><span style="color: #800000;">ANR</span><span style="color: #800000;">"</span>).when(text=<span style="color: #800000;">"</span><span style="color: #800000;">Wait</span><span style="color: #800000;">"</span><span style="color: #000000;">) \
</span><span style="color: #008080;">10</span>                              .click(text=<span style="color: #800000;">"</span><span style="color: #800000;">Force Close</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">11</span> <span style="color: #008000;">#</span><span style="color: #008000;"> d.watcher(name) ## creates a new named watcher.</span>
<span style="color: #008080;">12</span> <span style="color: #008000;">#</span><span style="color: #008000;">  .when(condition)  ## the UiSelector condition of the watcher.</span>
<span style="color: #008080;">13</span> <span style="color: #008000;">#</span><span style="color: #008000;">  .click(target)  ## perform click action on the target UiSelector.</span>
<span style="color: #008080;">14</span> There <span style="color: #0000ff;">is</span><span style="color: #000000;"> also a trick about click. You can use click without arguments.
</span><span style="color: #008080;">15</span> 
<span style="color: #008080;">16</span> d.watcher(<span style="color: #800000;">"</span><span style="color: #800000;">ALERT</span><span style="color: #800000;">"</span>).when(text=<span style="color: #800000;">"</span><span style="color: #800000;">OK</span><span style="color: #800000;">"</span><span style="color: #000000;">).click()
</span><span style="color: #008080;">17</span> <span style="color: #008000;">#</span><span style="color: #008000;"> Same as</span>
<span style="color: #008080;">18</span> d.watcher(<span style="color: #800000;">"</span><span style="color: #800000;">ALERT</span><span style="color: #800000;">"</span>).when(text=<span style="color: #800000;">"</span><span style="color: #800000;">OK</span><span style="color: #800000;">"</span>).click(text=<span style="color: #800000;">"</span><span style="color: #800000;">OK</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">19</span> <span style="color: #000000;">Press key when a condition becomes true
</span><span style="color: #008080;">20</span> d.watcher(<span style="color: #800000;">"</span><span style="color: #800000;">AUTO_FC_WHEN_ANR</span><span style="color: #800000;">"</span>).when(text=<span style="color: #800000;">"</span><span style="color: #800000;">ANR</span><span style="color: #800000;">"</span>).when(text=<span style="color: #800000;">"</span><span style="color: #800000;">Wait</span><span style="color: #800000;">"</span><span style="color: #000000;">) \
</span><span style="color: #008080;">21</span>                              .press(<span style="color: #800000;">"</span><span style="color: #800000;">back</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">home</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">22</span> <span style="color: #008000;">#</span><span style="color: #008000;"> d.watcher(name) ## creates a new named watcher.</span>
<span style="color: #008080;">23</span> <span style="color: #008000;">#</span><span style="color: #008000;">  .when(condition)  ## the UiSelector condition of the watcher.</span>
<span style="color: #008080;">24</span> <span style="color: #008000;">#</span><span style="color: #008000;">  .press(&lt;keyname&gt;, ..., &lt;keyname&gt;.()  ## press keys one by one in sequence.</span>
<span style="color: #008080;">25</span> Check <span style="color: #0000ff;">if</span><span style="color: #000000;"> the named watcher triggered
</span><span style="color: #008080;">26</span> 
<span style="color: #008080;">27</span> A watcher <span style="color: #0000ff;">is</span> triggered, which means the watcher was run <span style="color: #0000ff;">and</span><span style="color: #000000;"> all its conditions matched.
</span><span style="color: #008080;">28</span> 
<span style="color: #008080;">29</span> d.watcher(<span style="color: #800000;">"</span><span style="color: #800000;">watcher_name</span><span style="color: #800000;">"</span><span style="color: #000000;">).triggered
</span><span style="color: #008080;">30</span> <span style="color: #008000;">#</span><span style="color: #008000;"> true in case of the specified watcher triggered, else false</span>
<span style="color: #008080;">31</span> <span style="color: #000000;">Remove a named watcher
</span><span style="color: #008080;">32</span> 
<span style="color: #008080;">33</span> <span style="color: #008000;">#</span><span style="color: #008000;"> remove the watcher</span>
<span style="color: #008080;">34</span> d.watcher(<span style="color: #800000;">"</span><span style="color: #800000;">watcher_name</span><span style="color: #800000;">"</span><span style="color: #000000;">).remove()
</span><span style="color: #008080;">35</span> <span style="color: #000000;">List all watchers
</span><span style="color: #008080;">36</span> 
<span style="color: #008080;">37</span> <span style="color: #000000;">d.watchers
</span><span style="color: #008080;">38</span> <span style="color: #008000;">#</span><span style="color: #008000;"> a list of all registered watchers</span>
<span style="color: #008080;">39</span> Check <span style="color: #0000ff;">for</span><span style="color: #000000;"> any triggered watcher
</span><span style="color: #008080;">40</span> 
<span style="color: #008080;">41</span> <span style="color: #000000;">d.watchers.triggered
</span><span style="color: #008080;">42</span> <span style="color: #008000;">#</span><span style="color: #008000;">  true in case of any watcher triggered</span>
<span style="color: #008080;">43</span> <span style="color: #000000;">Reset all triggered watchers
</span><span style="color: #008080;">44</span> 
<span style="color: #008080;">45</span> <span style="color: #008000;">#</span><span style="color: #008000;"> reset all triggered watchers, after that, d.watchers.triggered will be false.</span>
<span style="color: #008080;">46</span> <span style="color: #000000;">d.watchers.reset()
</span><span style="color: #008080;">47</span> <span style="color: #000000;">Remove watchers
</span><span style="color: #008080;">48</span> 
<span style="color: #008080;">49</span> <span style="color: #008000;">#</span><span style="color: #008000;"> remove all registered watchers</span>
<span style="color: #008080;">50</span> <span style="color: #000000;">d.watchers.remove()
</span><span style="color: #008080;">51</span> <span style="color: #008000;">#</span><span style="color: #008000;"> remove the named watcher, same as d.watcher("watcher_name").remove()</span>
<span style="color: #008080;">52</span> d.watchers.remove(<span style="color: #800000;">"</span><span style="color: #800000;">watcher_name</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">53</span> <span style="color: #000000;">Force to run all watchers
</span><span style="color: #008080;">54</span> 
<span style="color: #008080;">55</span> <span style="color: #008000;">#</span><span style="color: #008000;"> force to run all registered watchers</span>
<span style="color: #008080;">56</span> d.watchers.run()</pre>
</div>
<p>注：里面涉及的watcher_name可以自定义，可以做到见名知意即可</p>
<p>watcher的使用是要先注册（第9行至20行均是注册watcher的方法），然后激活watcher(第56行)，注意这个激活方法只是一个瞬时激活，就是说使用之后即销毁，不会一直存于后台。那这样的话在实际的使用场景中怎么使用这个功能呢，下面看一段脚本<span style="color: #008080;">&nbsp;1</span> <span style="color: #008000;">#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span></p>
<div class="cnblogs_code">
<pre><code><em id="__mceDel"><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> uiautomator2 as u2
</span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> time
</span><span style="color: #008080;"> 5</span> 
<span style="color: #008080;"> 6</span> 
<span style="color: #008080;"> 7</span> d =<span style="color: #000000;"> u2.connect()
</span><span style="color: #008080;"> 8</span> cfg =<span style="color: #000000;"> MTBFConfig()
</span><span style="color: #008080;"> 9</span> package = cfg.getstr(<span style="color: #800000;">"</span><span style="color: #800000;">Admit</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">pkg</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">config</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">10</span> PACKAGELIST = package.split(<span style="color: #800000;">"</span><span style="color: #800000;">,</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">11</span> <span style="color: #0000ff;">print</span><span style="color: #000000;">(PACKAGELIST)
</span><span style="color: #008080;">12</span> <strong><span style="color: #ff0000;">d.watcher("&lrm;&rlm;&lrm;&lrm;&lrm;&lrm;&lrm;&rlm;&lrm;&rlm;&rlm;&rlm;&lrm;&lrm;&lrm;&lrm;&lrm;&rlm;&lrm;&lrm;&rlm;&lrm;&lrm;&lrm;&lrm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&lrm;&lrm;&lrm;&lrm;&lrm;&lrm;&lrm;&lrm;&lrm;&rlm;&lrm;&lrm;&lrm;&rlm;&lrm;&lrm;&rlm;&rlm;&lrm;&rlm;&lrm;&rlm;&lrm;&lrm;&lrm;&rlm;&rlm;&rlm;&lrm;&rlm;&rlm;&rlm;&lrm;&rlm;&rlm;&lrm;&lrm;&lrm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&lrm;&lrm;&rlm;&lrm;&lrm;&rlm;&rlm;&lrm;&lrm;&lrm;&rlm;&lrm;&lrm;&lrm;&rlm;&rlm;&rlm;&lrm;ALLOW&lrm;&rlm;&lrm;&lrm;&rlm;&lrm;").when(text="&lrm;&rlm;&lrm;&lrm;&lrm;&lrm;&lrm;&rlm;&lrm;&rlm;&rlm;&rlm;&lrm;&lrm;&lrm;&lrm;&lrm;&rlm;&lrm;&lrm;&rlm;&lrm;&lrm;&lrm;&lrm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&lrm;&lrm;&lrm;&lrm;&lrm;&lrm;&lrm;&lrm;&lrm;&rlm;&lrm;&lrm;&lrm;&rlm;&lrm;&lrm;&rlm;&rlm;&lrm;&rlm;&lrm;&rlm;&lrm;&lrm;&lrm;&rlm;&rlm;&rlm;&lrm;&rlm;&rlm;&rlm;&lrm;&rlm;&rlm;&lrm;&lrm;&lrm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&lrm;&lrm;&rlm;&lrm;&lrm;&rlm;&rlm;&lrm;&lrm;&lrm;&rlm;&lrm;&lrm;&lrm;&rlm;&rlm;&rlm;&lrm;ALLOW&lrm;&rlm;&lrm;&lrm;&rlm;&lrm;").click(text="&lrm;&rlm;&lrm;&lrm;&lrm;&lrm;&lrm;&rlm;&lrm;&rlm;&rlm;&rlm;&lrm;&lrm;&lrm;&lrm;&lrm;&rlm;&lrm;&lrm;&rlm;&lrm;&lrm;&lrm;&lrm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&lrm;&lrm;&lrm;&lrm;&lrm;&lrm;&lrm;&lrm;&lrm;&rlm;&lrm;&lrm;&lrm;&rlm;&lrm;&lrm;&rlm;&rlm;&lrm;&rlm;&lrm;&rlm;&lrm;&lrm;&lrm;&rlm;&rlm;&rlm;&lrm;&rlm;&rlm;&rlm;&lrm;&rlm;&rlm;&lrm;&lrm;&lrm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&rlm;&lrm;&lrm;&rlm;&lrm;&lrm;&rlm;&rlm;&lrm;&lrm;&lrm;&rlm;&lrm;&lrm;&lrm;&rlm;&rlm;&rlm;&lrm;ALLOW&lrm;&rlm;&lrm;&lrm;&rlm;&lrm;")
</span></strong><span style="color: #008080;">13</span> <span style="color: #008000;">#</span><span style="color: #008000;">d.watchers.run()</span>
<span style="color: #008080;">14</span> <span style="color: #0000ff;">print</span><span style="color: #000000;">(d.watchers)
</span><span style="color: #008080;">15</span> 
<span style="color: #008080;">16</span> time.sleep(2<span style="color: #000000;">)
</span><span style="color: #008080;">17</span> pkglen =<span style="color: #000000;"> len(PACKAGELIST)
</span><span style="color: #008080;">18</span> <span style="color: #0000ff;">print</span>((<span style="color: #800000;">"</span><span style="color: #800000;">There are %d package for test</span><span style="color: #800000;">"</span>) %<span style="color: #000000;">pkglen)
</span><span style="color: #008080;">19</span> 
<span style="color: #008080;">20</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Admit(object):
</span><span style="color: #008080;">21</span> 
<span style="color: #008080;">22</span>     <span style="color: #0000ff;">def</span><span style="color: #000000;"> main(self):
</span><span style="color: #008080;">23</span>         <span style="color: #0000ff;">for</span> i <span style="color: #0000ff;">in</span><span style="color: #000000;"> range(pkglen):
</span><span style="color: #008080;">24</span>             k =<span style="color: #000000;"> 0
</span><span style="color: #008080;">25</span>             <span style="color: #0000ff;">for</span> j <span style="color: #0000ff;">in</span> range(5<span style="color: #000000;">):
</span><span style="color: #008080;">26</span>                 <span style="color: #0000ff;">if</span> d.info[<span style="color: #800000;">'</span><span style="color: #800000;">currentPackageName</span><span style="color: #800000;">'</span>] !=<span style="color: #000000;"> PACKAGELIST[i]:
</span><span style="color: #008080;">27</span> <span style="color: #000000;">                    d.app_start(PACKAGELIST[i])
</span><span style="color: #008080;">28</span>                     <span style="color: #0000ff;">print</span><span style="color: #000000;">(PACKAGELIST[i])
</span><span style="color: #008080;">29</span>                     time.sleep(1<span style="color: #000000;">)
</span><span style="color: #008080;">30</span>                     k += 1
<span style="color: #008080;">31</span>                 <span style="color: #0000ff;">if</span> k == 3<span style="color: #000000;">:
</span><span style="color: #008080;">32</span>                     <span style="color: #0000ff;">print</span>(<span style="color: #800000;">"</span><span style="color: #800000;">Can not enter </span><span style="color: #800000;">"</span>+<span style="color: #000000;"> str(PACKAGELIST[i]))
</span><span style="color: #008080;">33</span>                     <span style="color: #0000ff;">return</span><span style="color: #000000;"> False
</span><span style="color: #008080;">34</span>             <span style="color: #0000ff;">if</span> PACKAGELIST[i] == <span style="color: #800000;">'</span><span style="color: #800000;">com.google.android.contacts</span><span style="color: #800000;">'</span><span style="color: #000000;">:
</span><span style="color: #008080;">35</span>                 <span style="color: #0000ff;">print</span>(<span style="color: #800000;">"</span><span style="color: #800000;">hello</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">36</span>                 <span style="color: #0000ff;">if</span> d(description = <span style="color: #800000;">"</span><span style="color: #800000;">Open navigation drawer</span><span style="color: #800000;">"</span>).exists(timeout = 5<span style="color: #000000;">):
</span><span style="color: #008080;">37</span>                     d(description = <span style="color: #800000;">"</span><span style="color: #800000;">Open navigation drawer</span><span style="color: #800000;">"</span><span style="color: #000000;">).click()
</span><span style="color: #008080;">38</span>                     
<span style="color: #008080;">39</span>                 <span style="color: #0000ff;">if</span> d(text = <span style="color: #800000;">"</span><span style="color: #800000;">Settings</span><span style="color: #800000;">"</span>).exists(timeout = 5<span style="color: #000000;">):
</span><span style="color: #008080;">40</span>                     d(text = <span style="color: #800000;">"</span><span style="color: #800000;">Settings</span><span style="color: #800000;">"</span><span style="color: #000000;">).click()
</span><span style="color: #008080;">41</span>                     
<span style="color: #008080;">42</span>                 <span style="color: #0000ff;">if</span> d(resourceId=<span style="color: #800000;">"</span><span style="color: #800000;">android:id/title</span><span style="color: #800000;">"</span>, text = <span style="color: #800000;">"</span><span style="color: #800000;">Import</span><span style="color: #800000;">"</span>).exists(timeout=5<span style="color: #000000;">):
</span><span style="color: #008080;">43</span>                     d(resourceId=<span style="color: #800000;">"</span><span style="color: #800000;">android:id/title</span><span style="color: #800000;">"</span>, text = <span style="color: #800000;">"</span><span style="color: #800000;">Import</span><span style="color: #800000;">"</span><span style="color: #000000;">).click()
</span><span style="color: #008080;">44</span>                     time.sleep(3<span style="color: #000000;">)
</span><span style="color: #008080;">45</span> 
<span style="color: #008080;">46</span>                 <span style="color: #0000ff;">if</span> d(resourceId = <span style="color: #800000;">"</span><span style="color: #800000;">android:id/button1</span><span style="color: #800000;">"</span>, text = <span style="color: #800000;">"</span><span style="color: #800000;">OK</span><span style="color: #800000;">"</span>).exists(timeout = 5<span style="color: #000000;">):
</span><span style="color: #008080;">47</span>                     d(resourceId = <span style="color: #800000;">"</span><span style="color: #800000;">android:id/button1</span><span style="color: #800000;">"</span>, text = <span style="color: #800000;">"</span><span style="color: #800000;">OK</span><span style="color: #800000;">"</span><span style="color: #000000;">).click()
</span><span style="color: #008080;">48</span>                     time.sleep(1<span style="color: #000000;">)
</span><span style="color: #008080;">49</span> <strong><span style="color: #ff0000;">                    d.watchers.run()  //在上面OK点击之后会弹出一个权限访问的许可，所以这个时候需要激活一次watcher把弹框关掉，以便不影响后续测试，所以就一个原则，哪里可能会有弹框就在哪里激活watcher
</span></strong><span style="color: #008080;">50</span> 
<span style="color: #008080;">51</span>             
<span style="color: #008080;">52</span> 
<span style="color: #008080;">53</span> <span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span>==<span style="color: #800000;">"</span><span style="color: #800000;">__main__</span><span style="color: #800000;">"</span><span style="color: #000000;">:
</span><span style="color: #008080;">54</span>     ad =<span style="color: #000000;"> Admit()
</span><span style="color: #008080;">55</span>     ad.main()</em></pre>
</div>
<p>&nbsp;</p>
</div>
</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>